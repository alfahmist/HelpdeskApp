CREATE PROCEDURE [dbo].[SP_GetOpenedTicket]

AS
BEGIN

	SELECT tic.Id AS 'TicketID',tic.[Name] AS 'Ticket Name', tic.EmployeeId AS 'Requestor', tic.CreatedDate AS 'Open Date', tic.[Description] AS 'Description', TMessage.[Subject] AS 'Ticket SUbject', TMessage.[Message] AS 'Ticket Message', st.[Name] AS 'Ticket Status', ts.StatusDate AS 'Status Date'
						
	FROM TB_T_Ticket as tic
	JOIN TB_T_TicketMessage AS TMessage ON TMessage.TicketId = tic.Id
	JOIN TB_T_TicketStatus AS ts ON ts.TicketId = tic.Id
	JOIN TB_M_Status AS st ON ts.StatusId = st.Id
	WHERE ts.StatusId = 1
	AND NOT EXISTS 
	(
		SELECT tic.Id AS 'TicketID',tic.[Name] AS 'Ticket Name', tic.EmployeeId AS 'Requestor', tic.CreatedDate AS 'Open Date', tic.[Description] AS 'Description', TMessage.[Subject] AS 'Ticket SUbject', TMessage.[Message] AS 'Ticket Message', st.[Name] AS 'Ticket Status', ts.StatusDate AS 'Status Date'
		FROM TB_T_Ticket as tic
		JOIN TB_T_TicketMessage AS TMessage ON TMessage.TicketId = tic.Id
		JOIN TB_T_TicketStatus AS ts ON ts.TicketId = tic.Id
		JOIN TB_M_Status AS st ON ts.StatusId = st.Id
		WHERE ts.StatusId = 3 AND ts.StatusId = 2
	)
END
